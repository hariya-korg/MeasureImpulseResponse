<!DOCTYPE HTML>
<html>

<head>
    <meta charset='utf-8'></meta>
    <title>Measure Impulse Response</title>
    <link type='text/css' rel='stylesheet' href='style.css'></link>
    <script type="text/javascript" src="fft.js"></script>
    <script src="jquery-2.0.3.min.js"></script>
    <script src="jquery.xdomainajax.js"></script>
    <script type='text/javascript'>


    var files = [
        "guitar.wav","ir3.wav"
    ];
    var source2 = null;
    var convolver = audioCtx.createConvolver();
    var revlevel = audioCtx.createGain();
    revlevel.gain.value=0.5;
    convolver.connect(revlevel);
    revlevel.connect(audioCtx.destination);
    var buffers = [];
    var loadidx = 0;
    var req = new XMLHttpRequest();
    function LoadBuffers() {
        req.open("GET", files[loadidx], true);
        req.responseType = "arraybuffer";
        req.onload = function() {
            if(req.response) {
                audioCtx.decodeAudioData(req.response,function(b){
                    buffers[loadidx]=b;
                    if(++loadidx < files.length)
                        LoadBuffers();
                },function(){});
            }
            else
                buffers[loadidx] = audioCtx.createBuffer(VBArray(req.responseBody).toArray(), false);
        };
        req.send();
    }
    (function(){//wavのステレオ化、グラフの色指定、ダウンロードボタンの無効化、
        var status,measure,calib;
        var console_obj = window.console;
        var N,n,j,a;
        var latency  = 4096;
        var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        var sampleRate;
        var ir;
        var scriptNode;




            function Setup() {
                var lev=document.getElementById("revlevel").value;
                revlevel.gain.value=parseInt(lev)*0.01;
                document.getElementById("revdisp").innerHTML=lev;
            }
            function Play() {
                if(source2 == null) {
                    source2 = audioCtx.createBufferSource();
                    source2.buffer = buffers[0];
                    convolver.buffer = buffers[1];
                    source2.loop = true;
                    // source2.connect(audioCtx.destination);
                    source2.connect(convolver);
                    source2.start(0);
                }
                else {
                    source2.stop(0);
                    source2 = null;
                }
            }

            function onDOMContentLoaded() {




                document.getElementById('playconv').addEventListener('click',function(event){
                    Play();
                },false);
            }

            window.addEventListener('DOMContentLoaded', onDOMContentLoaded, false);

        })();



    </script>
</head>

<body onload="LoadBuffers()">
    <button id='playconv'>Play</button>
    ReverbLevel : <input type="range" id="revlevel" min="0" max="100" value="50" onchange="Setup()"/><span id="revdisp">50</span>

</body>

</html>
